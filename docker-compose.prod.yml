services:
  backend:
    image: ${BACKEND_IMAGE:-minierp-backend:latest}
    env_file:
      - .env
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - PORT=${BACKEND_PORT:-5000}
      # Database connection (for host-installed Postgres set DB_HOST to host address)
      - DB_HOST=${DB_HOST:-host.docker.internal}
      - DB_PORT=${DB_PORT:-5432}
      - DB_NAME=${DB_NAME:-minierp}
      - DB_USER=${DB_USER:-user}
      - DB_PASSWORD=${DB_PASSWORD:-password}
    ports:
      - "${BACKEND_PORT:-5000}:5000"
    # If your Postgres is installed on the Docker host, map host.docker.internal to the host gateway
    # This works on Docker Desktop (mac/windows). On Linux, ensure your daemon supports host-gateway
    extra_hosts:
      - "host.docker.internal:172.17.0.1"
    # Use a named volume by default to avoid permission problems with host bind mounts.
    # To use a host path instead, set `UPLOADS_PATH=/path/on/host` in your `.env`.
    volumes:
      - backend-uploads-salsamart:/usr/src/app/uploads
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:5000/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3

  frontend:
    image: ${FRONTEND_IMAGE:-minierp-frontend:latest}
    env_file:
      - .env
    environment:
      - NODE_ENV=${NODE_ENV:-production}
    ports:
      - "${FRONTEND_PORT:-80}:80"
    restart: unless-stopped
    depends_on:
      - backend

volumes:
  backend-uploads-salsamart:
    driver: local

networks:
  default:
    driver: bridge
